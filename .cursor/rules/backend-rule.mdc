---
alwaysApply: false
---
# Backend API Rules â€” **FastAPI + Python 3.12**

## 1 Â· Stack & Project Layout

* **FastAPI 0.110** + **Python 3.12**; all backend code lives in `/backend`
* Top-level folders:

  * **`app/`** â†’ entry (`main.py`), dependency wiring
  * **`routers/`** â†’ one file per feature (`users.py`, `auth.py`, â€¦)
  * **`services/`** â†’ pure business logic, no HTTP objects
  * **`models/`** â†’ Pydantic schemas & SQLAlchemy models
  * **`core/`** â†’ settings, security, logging, errorâ€handling utilities
  * **`tests/`** â†’ pytest suites (see Â§ 9)
* Configuration via `.env` + [`pydantic.Settings`](mdc:https:/docs.pydantic.dev/latest/usage/pydantic_settings) (loaded once in `core/config.py`)â€”**never** hard-code secrets.

## 2 Â· CORS

* App is public; keep CORS permissive:

  ```python
  app.add_middleware(
      CORSMiddleware,
      allow_origins=["*"],
      allow_methods=["*"],
      allow_headers=["*"],
  )
  ```
* Re-evaluate origins as soon as deployment endpoints are known.

## 3 Â· Logging Principles

| Goal                    | Practice                                                                                                                |
| ----------------------- | ----------------------------------------------------------------------------------------------------------------------- |
| **No secret leakage**   | Structured logging with **`structlog`**; redact headers & body fields named `*key*`, `*secret*`, `password`, `token`.   |
| **Trace success paths** | Each router handler ends with `logger.info("ğŸŸ¢ {endpoint} OK", status=status_code, elapsed=ms)`.                        |
| **Trace failures**      | Custom middleware captures all uncaught exceptions and calls `logger.exception("ğŸ”´ {endpoint} FAILED", exc_info=True)`. |
| **Correlation**         | `request_id` (UUID v4) attached via middleware; echoed in every log line and response header.                           |

## 4 Â· Error Handling & Responses

* Do **not** expose internals:

  ```python
  @app.exception_handler(Exception)
  async def unhandled_exc(request: Request, exc: Exception):
      # error already logged by middleware
      return JSONResponse(
          status_code=500,
          content={"detail": "Internal server error"},
      )
  ```
* Client-side errors (`HTTPException`) return only sanitized messages set by the developer.
* `debug=False` in production; Uvicorn access logs stay enabled.

## 5 Â· Endpoint Architecture

* **Async** handlers (`async def`) everywhere; DB/HTTP calls use async drivers & pools.
* Pydantic models validate input/output; never return raw ORM objects.
* Every router file registers its routes under a **versioned prefix** (`/v1/users`, `/v1/chat`, â€¦).

## 6 Â· Security Essentials

* JWT (HS256 / RS256) auth, 15 min access + refresh rotation.
* Rate-limit sensitive endpoints (e.g., login) with Redis leaky bucket.
* `Secure` & `HttpOnly` cookies; CSRF token for browser sessions.
* Regular dependency review with `pip-audit`; CI fails on known CVEs.

## 7 Â· Observability & Metrics

* **Prometheus** metrics via `prometheus_fastapi_instrumentator` (latency, throughput, errors).
* `/healthz` liveness & `/readyz` readiness endpoints.
* Optional OpenTelemetry traces exported to Grafana Tempo.

## 8 Â· Performance

* Gunicorn with Uvicorn workers in prod (`workers = CPU Ã— 2 + 1`).
* Reuse HTTP clients / DB sessions via lifespan events.
* Cache expensive lookups (e.g., config, static DB tables) in Redis with sensible TTL.

## 9 Â· Quality Gates & Testing

* **Pytest + httpx.AsyncClient**; â‰¥ 95 % line & branch coverage (enforced in CI).
* Each new endpoint **must** ship with âœ… success-path test + âŒ error-path test.
* Refactor â‡’ update or replace impacted tests; delete obsolete fixtures.
* Ruff, MyPy (strict), Black; GitHub Actions: install â†’ lint â†’ type-check â†’ test.

## 10 Â· Comment & Docstring Guidelines

* File, class & function **docstrings** explain purpose, inputs, outputsâ€”concise, third-person, team-oriented.
* Inline comments only for **non-obvious logic**, phrased professionally; never reference individuals (â€œyouâ€, â€œIâ€), e.g.:

  ```python
  # Compute HMAC once to avoid leaking processing time per attempt
  ```

---
